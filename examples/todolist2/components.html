<div data-view-name="Filters" class="todo-filters"
	bind-var-filters="['All', 'Active', 'Completed']">
	<span class="filter"
		bind-repeater-i="#filters.length"
		bind-statement-1="$(thisElem).toggleClass('active', #currentFilter == #filters[#i])"
		bind-event-click="this.setFilter(#filters[#i])">
		{{#filters[#i]}}
	</span>
</div>

<div data-view-name="TodoList" class="todo-list">
	<h1>TODO</h1>
	<div bind-view="Filters"
		bind-param-current-filter="#currentFilter"
		bind-event-set-filter="#currentFilter = event.data">
	</div>
	<ul bind-var-filtered-items="#updateFlag, #items.filter($.proxy(this.filterFunc, this))">
		<li>
			<input type="text" placeholder="What to do?"
				bind-event-keypress="if (event.which == 13) { this.addItem(thisElem.value); thisElem.value = ''; return false; }" />
		</li>
		<li bind-repeater-i="#filteredItems.length"
			bind-var-item="#filteredItems[#i]"
			bind-view="TodoItem"
			bind-param-text="#item.text"
			bind-param-completed="#item.completed"
			bind-param-edit-mode="#item == #editItem"
			bind-event-start-edit="#editItem = #item"
			bind-event-stop-edit="#editItem = null"
			bind-event-set-completed="this.setCompleted(#item, event.data)"
			bind-event-set-text="this.setText(#item, event.data)"
			bind-event-delete-item="this.deleteItem(#item)">
		</li>
	</ul>
	<div>
		{{#updateFlag, #items.filter(function(item) {return !item.completed}).length || "No"}} things to do
	</div>
	<!-- the following detects when items are added/deleted, when their completed state change,
		or when the selected filter changes, and set the updateFlag
	-->
	<div bind-statement-1="#items.length, #currentFilter, #updateFlag++">
		<div bind-repeater-i="#items.length"
			bind-statement-1="#items[#i].completed, #updateFlag++"></div>
	</div>
</div>

<li data-view-name="TodoItem" class="todo-item">
	<div class="delete-button"
		bind-event-click="this.deleteItem()">X</div>
	<input type="checkbox"
		bind-statement-1="thisElem.checked = #completed"
		bind-event-change="this.setCompleted(thisElem.checked)" />
	<span bind-statement-1="$(thisElem).toggle(!#editMode)"
		bind-statement-2="$(thisElem).css('text-decoration', #completed ? 'line-through' : 'none')"
		bind-event-click="this.startEdit()">
		{{#text}}
	</span>
	<input type="text"
		bind-statement-1="thisElem.value = #text"
		bind-statement-2="$(thisElem).toggle(#editMode); if (#editMode) thisElem.focus()"
		bind-event-keypress="if (event.which == 13) { this.setText(thisElem.value); this.stopEdit(); return false; }" />
</li>
