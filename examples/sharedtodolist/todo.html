<!DOCTYPE html>
<html>
<head>
	<link href="../todolist2/components.css" rel="stylesheet" type="text/css" />
	<style>
		body {
			font-family: Arial;
		}
	</style>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="../../databind.js"></script>
	<!-- here we use a fork of Starcounter-Jack's JSONPatch library that supports the non-standard "splice" op
		use this if you expect to insert/remove large number of array elements and are concerned about performance -->
	<script src="https://rawgit.com/ken107/JSON-Patch/master/src/json-patch.js"></script>
	<script src="../todolist2/components.js"></script>
	<script>
		//load components
		dataBinder.autoBind = false;
		$("<div/>").load("../todolist2/components.html", function() {
			$(this).children().each(function() {
				var viewName = $(this).data("viewName");
				dataBinder.views[viewName] = {template: this, controller: window[viewName]};
			});
			dataBinder.autoBind = true;
		});
	</script>
	<script>
		items = [];
		
		var ws = new (WebSocket || MozWebSocket)("ws://localhost:8080/todo");
		ws.onopen = function() {
			//specify that we can handle the non-standard "splice" op
			ws.send(JSON.stringify({cmd: "SUB", pointers: ["/items"], canSplice: true}));
		};
		ws.onmessage = function(e) {
			var m = eval('(' + e.data + ')');
			if (m.cmd == "PUB") jsonpatch.apply(window, m.patches);
		};
		function action(method, args) {
			ws.send(JSON.stringify({cmd: "ACT", method: method, args: args}));
		}
	</script>
</head>
<body>
	<div bind-view="TodoList"
		bind-param-items="#items"
		bind-event-add-item="action('addItem', [event.data])"
		bind-event-delete-item="action('deleteItem', [#items.indexOf(event.data)])"
		bind-event-set-completed="action('setCompleted', [#items.indexOf(event.data.item), event.data.completed])"
		bind-event-set-all-completed="action('setAllCompleted', [event.data])"
		bind-event-clear-completed="action('clearCompleted')"
		bind-event-set-text="action('setText', [#items.indexOf(event.data.item), event.data.text])">
	</div>
</body>
</html>
